{% extends "base.html" %}
{% block title %}–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤{% endblock %}
{% block content %}
<h1 class="page-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤</h1>
<p class="lead">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫–∏–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏ –∫–∞–Ω–∞–ª—ã –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–≥–æ–Ω.
</p>

<div class="card-list">
  {% for run in runs %}
  <div class="card">
    <div class="grid grid--cols-2">
      <div>
        <div class="muted">–ó–∞–ø—É—Å–∫ #{{ run.id }}</div>
        <div class="card__title">{{ run.started_at.strftime('%Y-%m-%d %H:%M') }} ‚Üí {{ run.finished_at.strftime('%H:%M')
          }} (–ú–°–ö)</div>
        <div class="inline-list mb-sm">
          {% set status_class = 'success' if run.status == 'success' else 'partial' if run.status == 'partial' else
          'error' %}
          <span class="status-badge {{ status_class }}">
            {% if run.status == 'success' %}
            ‚úÖ –£—Å–ø–µ—à–Ω–æ
            {% elif run.status == 'partial' %}
            ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ
            {% else %}
            ‚ùå –û—à–∏–±–∫–∞
            {% endif %}
          </span>
          <span class="pill">–ê–∫–∫–∞—É–Ω—Ç–æ–≤: {{ run.total_accounts }}</span>
          <span class="pill">–ù–æ–≤—ã–µ –≤–∏–¥–µ–æ: {{ run.new_videos }}</span>
          <span class="pill">–û—à–∏–±–æ–∫: {{ run.errors }}</span>
        </div>
      </div>
      <div class="muted text-right">
        –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {{ run.finished_at.strftime('%Y-%m-%d %H:%M') }}
      </div>
    </div>

    {% if run.failed_accounts is defined and run.failed_accounts|length > 0 %}
    <details class="mt-md">
      <summary>‚ùó –û—à–∏–±–∫–∏ ({{ run.failed_accounts|length }})</summary>
      <ul class="mt-sm">
        {% for fail in run.failed_accounts %}
        <li class="mb-xs">
          <details>
            <summary style="cursor: pointer; outline: none;">
              <span class="tag-chip {{ fail.platform }}">{{ fail.platform|e }}</span>
              <span class="tag-chip">{{ (fail.value or "?")|e }}</span>
              <span class="muted text-sm">...–ø–æ–¥—Ä–æ–±–Ω–µ–µ</span>
            </summary>
            <div class="mt-xs p-sm bg-muted rounded text-sm" style="white-space: pre-wrap; color: var(--destructive);">
              {{ fail.reason|e }}
            </div>
          </details>
        </li>
        {% endfor %}
      </ul>
    </details>
    {% endif %}

    {% if run.accounts_json and run.accounts_json|length > 0 %}
    {% if run.accounts_json %}
    <details class="mt-md">
      <summary>üë§ –ó–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã ({{ run.accounts_json|length }})</summary>
      <div class="inline-list mt-sm">
        {% for acc in run.accounts_json %}
        <span class="tag-chip">@{{ acc.value }}<span class="tag-chip__meta">¬∑ {{ acc.platform }}</span></span>
        {% endfor %}
      </div>
    </details>
    {% endif %}
    {% endif %}
  </div>
  {% endfor %}
</div>

<h2 class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã</h2>
<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>–ê–∫–∫–∞—É–Ω—Ç</th>
        <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for acc in accounts %}
      <tr>
        <td>{{ acc.account }}</td>
        <td>{{ acc.publish_date }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<p class="muted centered mt-lg">
  ‚è∞ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (–ú–°–ö): {{ now_moscow }}
</p>
{% endblock %}